#!/command/with-contenv bash
# SPDX-FileCopyrightText: Â© 2026 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

source /container/base/functions/container/init
output_off
d_e_o

if var_false "${CONTAINER_SKIP_SANITY_CHECK}" ; then
    output_off
    tmp_all=$(mktemp)
    tmp_done=$(mktemp)

    find /container/base/init/init.d/ /container/init/init.d/ -maxdepth 1 -type f \
        ! -name '*.enc*' ! -name '.nfrastack' ! -name 'zzz-container' -print 2>/dev/null | sed 's#.*/##' | sort -V > "${tmp_all}"

    find /container/state/init/ -maxdepth 1 -type f \
        ! -name '*.enc*' ! -name '.nfrastack' -print 2>/dev/null | sed -E 's#.*/##' | sed -E 's/-init$//' | sort -V > "${tmp_done}"


    files_init=$(wc -l < "${tmp_all}" 2>/dev/null || echo 0)
    init_complete=$(wc -l < "${tmp_done}" 2>/dev/null || echo 0)
    mapfile -t uninitialized_scripts < <(comm -23 "${tmp_all}" "${tmp_done}" 2>/dev/null)
    rm -f "${tmp_all}" "${tmp_done}"
    declare -p uninitialized_scripts >/dev/null 2>&1 || true

    # If any scripts in init.d are not present in /container/state/init, treat as uninitialized
    if [ "${#uninitialized_scripts[@]}" -gt 0 ]; then
        if [ -n "${IMAGE_NAME}" ] ; then
                if [ -f "/container/build/${IMAGE_NAME/\//_}/CHANGELOG.md" ] ; then
                    image_version=$(head -n1 /container/build/"${IMAGE_NAME/\//_}"/CHANGELOG.md | awk '{print $2}')
                    elif [ -f /container/build/docker-"${IMAGE_NAME/\//_}"/CHANGELOG.md ] ; then
                    image_version=$(head -n1 /container/build/docker-"${IMAGE_NAME/\//_}"/CHANGELOG.md | awk '{print $2}')
                else
                    if [ -f /container/build/nfrastack_docker-"${IMAGE_NAME/\//_}"/CHANGELOG.md ] ; then
                        image_version=$(head -n1 /container/build/nfrastack_docker-"${IMAGE_NAME/\//_}"/CHANGELOG.md | awk '{print $2}')
                    fi
                fi

                image_string="Image: ${IMAGE_NAME}"

                if [ -n "${image_version}" ] ; then
                    image_string="${image_string} | Version ${image_version} Type 'image_changelog' for details"
                fi

                image_string="${image_string}"

                if [ -n "${IMAGE_REPO_URL}" ] ; then
                    image_url="Repository: ${IMAGE_REPO_URL}"
                fi

            fi
            cat << EOF

**********************************************************************************************************************
**********************************************************************************************************************
****                                                                                                              ****
****       ERROR - Some initialization scripts haven't completed                                                  ****
****             - The following scripts in '/container/init/init.d' did not pass their completion check          ****
****             - All services are now halted                                                                    ****
****                                                                                                              ****
**********************************************************************************************************************
**********************************************************************************************************************

            $(printf "%s\n" "${uninitialized_scripts[@]}" | uniq -u)

**********************************************************************************************************************
**********************************************************************************************************************
****                                                                                                              ****
****       This could have happened for a variety of reasons. Please make sure you have followed the README       ****
****       relating to this image and have proper configuration such as environment variables and volumes set     ****
****                                                                                                              ****
****       If you feel that you have encountered a bug, please submit an issue on the revision control system     ****
****       and provide full debug logs by setting the environment variable 'CONTAINER_LOG_LEVEL=TRACE'            ****
****                                                                                                              ****
**********************************************************************************************************************
**********************************************************************************************************************

$image_string
$image_url
Support: https://www.nfrastack.com

EOF
            exit 1
    fi
    output_on
fi

for services in /container/base/run/available/*/ /container/run/available/*/ ; do
    service=${services%*/}
    if [ -f "/container/state/init/${service##*/}" ]; then
        if grep -q "DONOTSTART" "/container/state/init/${service##*/}"; then
            print_debug "Skipping '${service##*/}' service for startup routines"
        else
            print_debug "Getting ready to start '${service##*/}' service"
            ln -sf "${service}" /etc/services.d
        fi
    else
        print_debug "No Initialization Script Found - Getting ready to start '${service##*/}' service"
        ln -sf "${service}" /etc/services.d
    fi
done

if [ -n "${CONTAINER_INIT_POST_COMMAND}" ]; then
    if [ -f "${CONTAINER_INIT_POST_COMMAND}" ] && [ ! -x "${CONTAINER_INIT_POST_COMMAND}" ]; then
        chmod +x "${CONTAINER_INIT_POST_COMMAND}"
    fi
    print_debug "Executing post init command '${CONTAINER_INIT_POST_COMMAND}'"
    eval "${CONTAINER_INIT_POST_COMMAND}"
fi

liftoff