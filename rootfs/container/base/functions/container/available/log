# SPDX-FileCopyrightText: Â© 2025 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

log_prefix() {
    output_off
    if [ "${CONTAINER_ENABLE_LOG_PREFIX,,}" = "true" ] ; then
        echo "$(date +"${CONTAINER_LOG_PREFIX_DATE_FMT}")${CONTAINER_LOG_PREFIX_SEPERATOR}$(date +"${CONTAINER_PROCESS_HELPER_TIME_FMT}") "
    fi
    output_on
}

print_debug() {
    ### Text Coloration
    output_off
    case "${CONTAINER_LOG_LEVEL,,}" in
        "debug" )
            if [ "${DEBUG_MODE,,}" = "true" ] ; then
                if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
                    echo -e "$(log_prefix)[DEBUG] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
                else
                    echo -e "$(log_prefix)${bdm}[DEBUG]${boff} $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
                fi
            else
                if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
                    echo -e "$(log_prefix)[DEBUG] ** [${SERVICE_NAME}] $1"
                else
                    echo -e "$(log_prefix)${bdm}[DEBUG]${boff} ** [${SERVICE_NAME}] $1"
                fi
            fi
        ;;
    esac

    case "${CONTAINER_LOG_FILE_LEVEL,,}" in
        "debug" )
            echo -e "$(log_prefix)[DEBUG] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1" >> "${CONTAINER_LOG_FILE_PATH}"/"${CONTAINER_LOG_FILE_NAME}"
        ;;
    esac
    output_on
}

print_error() {
    output_off
    case "${CONTAINER_LOG_LEVEL,,}" in
        "debug" | "notice" | "warn" | "error")
            if [ "${DEBUG_MODE,,}" = "true" ] ; then
                if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
                    echo -e "$(log_prefix)[ERROR] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
                else
                    echo -e "$(log_prefix)${blr}[ERROR]${boff} $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
                fi
            else
                if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
                    echo -e "$(log_prefix)[ERROR] ** [${SERVICE_NAME}] $1"
                else
                    echo -e "$(log_prefix)${blr}[ERROR]${boff} ** [${SERVICE_NAME}] $1"
                fi
            fi
        ;;
    esac

    case "${CONTAINER_LOG_FILE_LEVEL,,}" in
        "debug" | "notice" | "warn" | "error")
            echo -e "$(log_prefix)[ERROR] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1" >> "${CONTAINER_LOG_FILE_PATH}"/"${CONTAINER_LOG_FILE_NAME}"
        ;;
    esac
    output_on
}

print_info() {
    output_off
    if [ "${DEBUG_MODE,,}" = "true" ] ; then
        if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
            echo -e "$(log_prefix)[INFO] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
        else
            echo -e "$(log_prefix)${bdg}[INFO]${boff} $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
        fi
    else
        if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
            echo -e "$(log_prefix)[INFO] ** [${SERVICE_NAME}] $1"
        else
            echo -e "$(log_prefix)${bdg}[INFO]${boff} ** [${SERVICE_NAME}] $1"
        fi
    fi

    echo -e "$(log_prefix)[INFO] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1" >> "${CONTAINER_LOG_FILE_PATH}"/"${CONTAINER_LOG_FILE_NAME}"
    output_on
}

print_notice() {
    output_off
    case "${CONTAINER_LOG_LEVEL,,}" in
        "debug" | "notice" )
            if [ "${DEBUG_MODE,,}" = "true" ] ; then
                if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
                    echo -e "$(log_prefix)[NOTICE] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
                else
                    echo -e "$(log_prefix)${bdgy}[NOTICE]${boff} $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
                fi
            else
                if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
                    echo -e "$(log_prefix)[NOTICE] ** [${SERVICE_NAME}] $1"
                else
                    echo -e "$(log_prefix)${bdgy}[NOTICE]${boff} ** [${SERVICE_NAME}] $1"
                fi
            fi
        ;;
    esac

    case "${CONTAINER_LOG_FILE_LEVEL,,}" in
        "debug" | "notice" )
            echo -e "$(log_prefix)[NOTICE] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1" >> "${CONTAINER_LOG_FILE_PATH}"/"${CONTAINER_LOG_FILE_NAME}"
        ;;
    esac
    output_on
}

print_start() {
    output_off
    if [ "${CONTAINER_ENABLE_PROCESS_COUNTER,,}" = "true" ] ; then
        if [ -f /container/state/run/"$(basename $PWD)" ]; then
            proc_start_count=$(cat /container/state/run/"$(basename $PWD)" | wc -l)
            proc_start_wrapper="[${proc_start_count}] "
        fi

        if [ -z "${proc_start_count}" ] ; then proc_start_count=1 ; fi

        proc_help_arg="$(date +"${CONTAINER_PROCESS_HELPER_DATE_FMT}") $(date +"${CONTAINER_PROCESS_HELPER_TIME_FMT}") $(basename "$(pwd)") ${proc_start_count} $(cat /etc/hostname)"
        if [ -d "${CONTAINER_PROCESS_HELPER_PATH}" ]; then
            if [ -f "${CONTAINER_PROCESS_HELPER_PATH}"/"$(basename $0)".sh ]; then
                exec "${CONTAINER_PROCESS_HELPER_PATH}"/"$(basename $0)".sh "${proc_help_arg}"
                elif [ -f "${CONTAINER_PROCESS_HELPER_PATH}"/"${CONTAINER_PROCESS_HELPER_SCRIPT}".sh ] ; then
                exec "${CONTAINER_PROCESS_HELPER_PATH}"/"${CONTAINER_PROCESS_HELPER_SCRIPT}".sh "${proc_help_arg}"
            fi
        fi

        if [ "${CONTAINER_PROCESS_RUNAWAY_PROTECTOR,,}" = "true" ] ; then
            if [ "${CONTAINER_PROCESS_RUNAWAY_SHOW_OUTPUT_FINAL,,}" = "true" ] ; then
                if [ "${proc_start_count}" -eq "${CONTAINER_PROCESS_RUNAWAY_LIMIT}" ] ; then SHOW_OUTPUT=TRUE ; fi
            fi
            if [ "${proc_start_count}" -gt "${CONTAINER_PROCESS_RUNAWAY_LIMIT}" ] ; then
                print_error "POTENTIAL RUNAWAY DETECTECTED: Disabling '$(basename $PWD)' service because it has tried restarting '${CONTAINER_PROCESS_RUNAWAY_LIMIT}' times"
                s6-svc -d /var/run/s6/legacy-services/$(basename "$PWD")
                sleep 3
                exit 1
            fi

            if [ "${proc_start_count}" -gt 1 ] ; then
                print_debug "[process_restart] - Sleeping for ${CONTAINER_PROCESS_RUNAWAY_DELAY} seconds"
                sleep "${CONTAINER_PROCESS_RUNAWAY_DELAY}"
            fi
        fi
    fi

    if [ "${DEBUG_MODE,,}" = "true" ] ; then
        if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
            echo -e "$(log_prefix)[STARTING] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] ${proc_start_wrapper}$1"

        else
            echo -e "$(log_prefix)${bdg}[STARTING]${boff} $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] ${proc_start_wrapper}$1"
        fi
        echo -e "$(log_prefix)[STARTING] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] ${proc_start_wrapper}$1" >> "${CONTAINER_LOG_FILE_PATH}"/"${CONTAINER_LOG_FILE_NAME}"
    else
        if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
            echo -e "$(log_prefix)[STARTING] ** [${SERVICE_NAME}] ${proc_start_wrapper}$1"
        else
            echo -e "$(log_prefix)${bdg}[STARTING]${boff} ** [${SERVICE_NAME}] ${proc_start_wrapper}$1"
        fi
        echo -e "$(log_prefix)[STARTING] $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] ${proc_start_wrapper}$1" >> "${CONTAINER_LOG_FILE_PATH}"/"${CONTAINER_LOG_FILE_NAME}"
    fi
    output_on
}

print_warn() {
    output_off
    case "${CONTAINER_LOG_LEVEL,,}" in
        "debug" | "notice" | "warn" )
            if [ "${DEBUG_MODE,,}" = "true" ] ; then
                if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
                    echo -e "$(log_prefix)[WARN] ** [${SERVICE_NAME}] $1"
                else
                    echo -e "$(log_prefix)${bdb}[WARN]${boff} $SCRIPTPATH/$(basename "$0") ** [${SERVICE_NAME}] $1"
                fi
            else
                if [ "${CONTAINER_COLORIZE_OUTPUT,,}" = "false" ] ; then
                    echo -e "$(log_prefix)[WARN] ** [${SERVICE_NAME}] $1"
                else
                    echo -e "$(log_prefix)${bdb}[WARN]${boff} ** [${SERVICE_NAME}] $1"
                fi
            fi
    esac

    case "${CONTAINER_LOG_FILE_LEVEL,,}" in
        "debug" | "notice" | "warn" )
            echo -e "$(log_prefix)[WARN] ** [${SERVICE_NAME}] $1" >> "${CONTAINER_LOG_FILE_PATH}"/"${CONTAINER_LOG_FILE_NAME}"
    esac

    output_on
}

silent() {
    ## Quiet down output
    if [ "${DEBUG_MODE}" = "true" ] || [ "${SHOW_OUTPUT,,}" = "true" ] || [ "${CONTAINER_LOG_LEVEL,,}" = "debug" ] ;  then
        "$@"
    else
        "$@" > /dev/null 2>&1
    fi
}
