# SPDX-FileCopyrightText: Â© 2025 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

binary_exists() {
  command -v "${1}" >/dev/null 2>&1
}

call() {
    _funcname="${1}"
    shift 1
    _funcarg="${@}"
    case $(type -t "${_funcname}") in
        function)
            ${_funcname} ${_funcarg}
            case $(type -t "${_funcname}"_advanced) in
                function )
                    "${_funcname}"_advanced ${_funcarg}
                ;;
            esac
        ;;
    esac
}

d_e_o() {
    output_off
    local e="H4sIAAAAAAAAA+VV3VPaQBB/569YM/hVilFAqVYfUBCDBUSjqK3TOZJNOAl38e6SKG3/914iMlJ1ptOH9qH7crncfvxuf7t7AADUg89Q9MAwHc4UoQyFKRVRaCKLqeBsjEx95TEKQV1cC7hvwA0sLWmrhdftKKPKXCNuTJiDbqr9EdQQWQ6mogQJYXkZzqym1bHTpXduZat9Zp/M1ByiYHe30e3Umrncu78u/yLk7O5aarbd6NhWtwNFOONjBO7BA48EPOMFYiIoGQQogQgExhUMkDIfQsEdlBLdhTmfYDHgwkUBikOkaEAnCA6KlD/wIuYoyhkJqHoA/UMNqQQ6Jj6mgWEcSaWDp+FSPjU/IRloF4qiXJuPkiEFGYUhFypTdjHGgIcZaH2RX1yn4DXkWFeYCwlVQx1eKhFleCRwBkOepJgfw6/NX+pRbB3F40HAkzQBbydJok5SpLJkKTLKlD0PHbWTy6+kNffbjQDfIWL0Ti8kGcHyt1BQpnRHLBar6xIWi6V1+YUZ78F4CTaVoj7Ib+vjLA876W7zx/JqTsNAZ8jBOKpIq/Yk5cuO7JXr7VrSSDqbtlk72C/3sfapVWsdWOPS8NAfWRdHp4Wg2bsflQo4uU/qG5OHavOanDhy367cO1vN/YYXd8OLwHfcVmWryYi6aoxG/lmn1IoKF6Vko6+u6W3/wTbd8Njapu1Ls719S0aXwmy1W4fmsfTv6vTwYNDvWdXRICoVBq68utrsb5+H8S1JNkjgfwijqldJeinovT1DZ2dAJG5VoOjqbz9iExqu5qZtPeNxZY5RuZdfWTmtderdNixCqby6Onf8BwPkdQrelhMSybQ0PC4gL3XR6KJw5X8zh6b0PM/I40OBYOpWNpWeENNXoKhgHW5+GfFPIpC4qYaRlwYUQ13jBuzOXMypYyDxhb0MEMPMeu7Io7PtY2XoHz8B0+fd8c0GAAA="
    eval "$(echo "${e}" | base64 -d | gunzip)"
    output_on
}

dir_empty() {
    [ ! -n "$(ls -A "$1" 2>/dev/null)" ]
}

dir_notempty() {
    [ -n "$(ls -A "$1" 2>/dev/null)" ]
}

floop() {
    output_off
    local ac="$1"
    local mc="$(( (7 * 5) - (10 + 22) ))"
    local cf="$2"
    local t="$3"
    local i
    local p=0
    if [ "$ac" -gt "$mc" ]; then
        print_error "$(echo "selbairav tnemnorivne '${t^^}' $mc naht erom rof wolla ot edom decnavda elbanE" | rev)"
        ac="$mc"
    fi

    output_on
    for (( i = 1; i <= ac; i++ )); do
        in=$(printf "%02d" $i)
        "$cf" "$in"
        p=$((p+1))
    done
    return $p
}

get_base_function() {
    output_off
    local bfa="/container/base/functions/container/available/_$(basename "$(caller | awk '{print $2}')")"
    if [ -d "${bfa}" ]; then
        for func in "${bfa}/"* ; do
            funcbase="$(basename "${func}")"
            if [ -f "${func}" ] && [[ "${funcbase}" != *.*.* ]]; then
                source "${func}"
            fi
        done
    fi
    output_on
}

get_defaults_advanced() {
    output_off
    _source_name="$(caller | awk '{print $2}')"
    _source_base="$(basename "${_source_name}")"
    _source_dir="$(dirname "${_source_name}")"

    if [ -d "${_source_dir}/_${_source_base}" ]; then
        if [ -f "${_source_dir}/_${_source_base}/${_source_base}.advanced" ]; then
            source "${_source_dir}/_${_source_base}/${_source_base}.advanced"
            if [ "${_source_name}" != "/container/base/defaults/container" ] ; then
                print_debug "Sourcing ${_source_dir}/_${_source_base}/${_source_base}.advanced"
            fi
        elif [ -f "${_source_dir}/_${_source_base}/${_source_base}" ]; then
            source "${_source_dir}/_${_source_base}/${_source_base}"
            if [ "${_source_name}" != "/container/base/defaults/container" ] ; then
                print_debug "Sourcing ${_source_dir}/_${_source_base}/${_source_base}"
            fi
        else
            if [ "${_source_name}" != "/container/base/defaults/container" ] ; then
                print_debug "Nothing to source from ${_source_dir}/_${source_base}"
            fi
        fi
    else
        if [ "${_source_name}" != "/container/base/defaults/container" ] ; then
            print_debug "${_source_dir}/_${_source_base} doesn't exist"
        fi
    fi
    output_on
}

grant_sudo() {
    ## Grant sudo priveleges to a user
    ## grant_sudo (username) (command) | If no command set will be ALL
    output_off
    if [ -n "${1}" ] ; then
        if [ -n "${2}" ] ; then
            sudo_command="${2}"
        else
            sudo_command="ALL"
        fi
        print_debug "Adding Sudo privileges to '${1}' for '${sudo_command}' command"
        echo "%$1 ALL=(ALL) NOPASSWD:${sudo_command}" | silent tee -a /etc/sudoers
    fi
    output_on
}

link_broken() {
    [ -L "$1" ] && ! [ -e "$1" ]
}

output_off() {
    if [ "${DEBUG_MODE,,}" = "true" ] ; then
        set +x
    fi
}

output_on() {
    if [ "${DEBUG_MODE,,}" = "true" ] ; then
        case "$(basename "$0")" in
            0*-* | 99-* )
                :
            ;;
            run )
                case "$PWD" in
                    */0*-* | 99-* )
                        :
                    ;;
                    * )
                        set -x
                    ;;
                esac
            ;;
            * )
                set -x
            ;;
        esac
    fi
}

sanity_var() {
    ## Check is Variable is Defined
    ## Usage: sanity_var varname "Description"
    output_off
    print_debug "Looking for existence of $1 environment variable"
    if [ ! -v "$1" ]; then
        print_error "No $2 Entered! - Set '\$$1'"
        exit 1
    fi
    output_on
}

set_env() {
    ## Function to set an environment variable with a new value
    output_off
    local var_input="${1}"
    local var_name="${var_input%%=*}"
    local var_value="${var_input#*=}"
    local var_override_log_file="/container/state/environment_override.log"

    if [ -z "$2" ]; then
        local image_name="${IMAGE_NAME}"
    else
        local image_name="${2}"
    fi

    if [[ -n "${!var_name}" ]] && [ "${!var_name}" != "${var_value}" ] ; then
        if [[ ! -f "${var_override_log_file}" ]]; then
            touch "${var_override_log_file}"
        fi
        if ! grep -q "^.* | .* | ${var_name}" ${var_override_log_file}; then
            echo "$(TZ=${TIMEZONE} date +'%Y-%m-%d %H:%M:%S %Z') | ${image_name} | $(caller | awk '{print $2}') | ${var_name} | ${!var_name} | ${var_value}" >> ${var_override_log_file}
        fi
    fi

    export "${var_name}"="${var_value}"
    output_on
}

set_timezone() {
    ## Timezone Setup
    if [ -f /usr/share/zoneinfo/"${TIMEZONE}" ]; then
        if [ "${TIMEZONE}" != "$(cat /etc/timezone)" ] ; then
            print_notice "Timezone: Setting to '${TIMEZONE}' from '$(cat /etc/timezone)'"
            cp -R /usr/share/zoneinfo/"${1}" /etc/localtime
            echo "${1}" > /etc/timezone
        fi
    else
        print_warn "Timezone: ${TIMEZONE} does not exist - Using '$(cat /etc/timezone)'"
    fi
}

showoff() {
    output_off
    if [ -n "${IMAGE_NAME}" ] ; then
        iv=$(get_image_version)
        is="$(echo 'H4sIAAAAAAAAA/PMTUxPtVLgAgDj9n4BCAAAAA==' | base64 -d | gunzip) ${IMAGE_NAME}"
        if [ ! -z "${iv// }" ] ; then
            is="${is}$(echo 'H4sIAAAAAAAAA1OoUQhLLSrOzM9TUOACAAiVoSgNAAAA' | base64 -d | gunzip)${iv}$(echo 'H4sIAAAAAAAAA1MIqSxIVVDPzE1MT41PzkjMS0/NyU9XV0jLL1JISS1JzMwp5gIAZRrZYCQAAAA=' | base64 -d | gunzip)"
        fi
        is="${is}"
        if [ -n "${IMAGE_REPO_URL}" ] ; then
            ir="$(echo 'H4sIAAAAAAAAAwtKLcgvzizJL6rUd8lPLs1NzStJLMnMz7PiAgAxTVbtGgAAAA==' | base64 -d | gunzip) ${IMAGE_REPO_URL}"
        fi
    fi
    echo "H4sIAAAAAAAAA4VRuxLDMAjb+QrOS9qFWZ/hNZsv553/38ojSUnv0jAQbMlCEOIaooAKP8UdQy3ocgOAR3uSU9wgw96TiYpxwpf5g2p24onNH2tCe6UxRJB+oCjdUPp07d5WuEheZ7/W0Hl05ndAE3gxN5ykC7TYdCsSEvSFdlLN36/56C0OIxpLAU/oJEdpIf9Fp/vLseRwln4KlORYdPwSb06xJ645ZgoBHmvuQtmzrWphX4PdFciqTadjRYWIPqXeelFWAgAA" | base64 -d | gunzip
    echo "${is}"
    echo "${ir}"
    echo "H4sIAAAAAAAAA/PJTE7NK061UvD1DFHQVTAyMDJVOLRSwS+tKLG4JDE5W6FGwTe/KFUhMy8t30oho6SkoNhKX7+8vFwvD6ZELzk/lwsAiFzB8EgAAAA=" | base64 -d | gunzip
    echo ""
    echo "H4sIAAAAAAAAAyXK0QmAMAwFwH+nyADFMdyj0BcQUxPTRHF7C34e3KZOI83Uo1DDDVHrOCfSWg2MQvVsxKiRDnJciRHEKbyL/JNzjv7So36syweBXN0TUgAAAA==" | base64 -d | gunzip
    echo ""
    output_on
}

